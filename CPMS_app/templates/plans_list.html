{% extends 'base.html' %}
{% load static %}

{% block title %}قائمة الخطط الاستراتيجية{% endblock %}

{% block content %}

<div class="max-w-4xl mx-auto px-6 mt-10" dir="rtl">
    <div class="overflow-x-auto bg-white shadow-sm rounded-lg border border-gray-200 max-h-[500px] overflow-y-auto">

        <!-- Container for Search, Filter, and Add Button-->
        <div class="p-4 flex items-center justify-between gap-4">

            <!-- Container for Search, Filter -->
            <div class="flex items-center gap-2">
                <!-- Search -->
                <div class="relative">
                    <div class="absolute inset-y-0 end-0 flex items-center pe-3 pointer-events-none">
                        <svg class="w-4 h-4 text-gray-400" xmlns="http://www.w3.org/2000/svg" fill="none"
                            viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M21 21l-4.35-4.35M17 10a7 7 0 1 1-14 0 7 7 0 0 1 14 0z" />
                        </svg>
                    </div>
                    <input type="text" id="search"
                        class="block w-80 pe-9 ps-3 py-2 border rounded-lg focus:ring-blue-500 focus:border-blue-500"
                        placeholder="ابحث عن خطة...">
                </div>

                <!-- Filter Button-->
                <div class="relative">
                    <button id="dropdownDefaultButton"
                        class="flex flex-row-reverse items-center justify-between text-body bg-neutral-secondary-medium border rounded text-gray-500 hover:text-gray-800 hover:bg-neutral-tertiary-medium shadow-xs font-medium leading-5 rounded-base text-sm px-3 py-2 focus:outline-none gap-2 "
                        type="button">
                        <svg class="w-4 h-4" xmlns="http://www.w3.org/2000/svg" fill="none"
                            viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-width="2"
                                d="M18.796 4H5.204a1 1 0 0 0-.753 1.659l5.302 6.058a1 1 0 0 1 .247.659v4.874a.5.5 0 0 0 .2.4l3 2.25a.5.5 0 0 0 .8-.4v-7.124a1 1 0 0 1 .247-.659l5.302-6.059c.566-.646.106-1.658-.753-1.658Z" />
                        </svg>
                        <span class="ml-1">الحالة</span>
                        <svg id="dropdownIcon" class="w-4 h-4 transition-transform duration-200"
                            xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="m19 9-7 7-7-7" />
                        </svg>
                    </button>

                    <!-- Dropdown Menu -->
                    <div id="dropdown"
                        class="absolute right-0 z-10 hidden bg-neutral-primary-medium border border-default-medium rounded-base shadow-lg w-32 overflow-hidden">
                        <ul class="p-2 text-sm text-body font-medium">
                            <li>
                                <button type="button" data-status=""
                                    class="filter-btn block w-full text-right px-4 py-2 hover:bg-gray-100">الكل</button>
                            </li>
                            <li>
                                <button type="button" data-status="active"
                                    class="filter-btn block w-full text-right px-4 py-2 hover:bg-gray-100">نشطة</button>
                            </li>
                            <li>
                                <button type="button" data-status="inactive"
                                    class="filter-btn block w-full text-right px-4 py-2 hover:bg-gray-100">غير نشطة</button>
                            </li>
                        </ul>
                    </div>
                </div>
            </div>

            <!-- Add button-->
            <div>
                <a href="{% url 'plan_create' %}"
                    class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-md text-sm font-medium">
                    إضافة خطة
                </a>
            </div>

        </div>

        <!-- Table -->
        <table class="w-full text-sm text-right text-gray-700">
            <thead class="text-xs bg-gray-50 border-b">
                <tr>
                    <th class="px-6 py-3 font-semibold">عنوان الخطة</th>
                    <th class="px-6 py-3 font-semibold">أُنشئت بواسطة</th>
                    <th class="px-6 py-3 font-semibold">الحالة</th>
                    <th class="px-6 py-3 font-semibold text-center">الإجراء</th>
                </tr>
            </thead>
            <tbody id="plansBody">
               {% include 'partials\plans_table_rows.html' %}
            </tbody>
        </table>
        
<nav class="flex items-center justify-between flex-wrap p-4 bg-white rounded-lg shadow-sm" aria-label="Table navigation" dir="rtl">
    <span class="text-sm font-normal text-gray-600 mb-4 md:mb-0 block w-full md:inline md:w-auto">
        عرض {{ page_obj.start_index }}-{{ page_obj.end_index }} من {{ page_obj.paginator.count }}
    </span>

    <ul class="flex -space-x-px text-sm">
        {% if page_obj.has_previous %}
        <li>
            <a href="?page={{ page_obj.previous_page_number }}"
               class="flex items-center justify-center text-gray-700 bg-gray-200 border border-gray-300 rounded-l-md hover:bg-gray-300 px-3 h-9 transition-colors">
               السابق
            </a>
        </li>
        {% else %}
        <li>
            <span class="flex items-center justify-center text-gray-400 bg-gray-100 border border-gray-300 rounded-l-md px-3 h-9 cursor-not-allowed">
                السابق
            </span>
        </li>
        {% endif %}

        {% for num in page_obj.paginator.page_range %}
            {% if page_obj.number == num %}
                <li>
                    <span class="flex items-center justify-center text-white bg-blue-600 border border-gray-300 px-3 h-9 rounded transition-colors">
                        {{ num }}
                    </span>
                </li>
            {% else %}
                <li>
                    <a href="?page={{ num }}" 
                       class="flex items-center justify-center text-gray-700 bg-gray-200 border border-gray-300 px-3 h-9 hover:bg-gray-300 rounded transition-colors">
                        {{ num }}
                    </a>
                </li>
            {% endif %}
        {% endfor %}

        {% if page_obj.has_next %}
        <li>
            <a href="?page={{ page_obj.next_page_number }}"
               class="flex items-center justify-center text-gray-700 bg-gray-200 border border-gray-300 rounded-r-md hover:bg-gray-300 px-3 h-9 transition-colors">
               التالي
            </a>
        </li>
        {% else %}
        <li>
            <span class="flex items-center justify-center text-gray-400 bg-gray-100 border border-gray-300 rounded-r-md px-3 h-9 cursor-not-allowed">
                التالي
            </span>
        </li>
        {% endif %}
    </ul>
</nav>

        </div>

<script>
document.addEventListener("DOMContentLoaded", function() {
    const dropdownBtn = document.getElementById("dropdownDefaultButton");
    const dropdownMenu = document.getElementById("dropdown");
    const dropdownIcon = document.getElementById("dropdownIcon");
    const filterButtons = document.querySelectorAll(".filter-btn");
    const searchInput = document.getElementById("search");
    const plansBody = document.getElementById("plansBody");

    let currentStatus = "";

    function fetchPlans(search='', status='', page=1) {
        const url = `?search=${encodeURIComponent(search)}&status=${status}&page=${page}`;
        fetch(url, { headers: { 'X-Requested-With': 'XMLHttpRequest' } })
        .then(res => res.json())
        .then(data => {
            plansBody.innerHTML = data.html;
        });
    }

    // Dropdown toggle
    dropdownBtn.addEventListener("click", e => {
        e.stopPropagation();
        dropdownMenu.classList.toggle("hidden");
        dropdownIcon.style.transform = dropdownMenu.classList.contains("hidden") ? "rotate(0deg)" : "rotate(180deg)";
    });
    document.addEventListener("click", () => {
        dropdownMenu.classList.add("hidden");
        dropdownIcon.style.transform = "rotate(0deg)";
    });
    dropdownMenu.addEventListener("click", e => e.stopPropagation());

    // البحث
    searchInput.addEventListener("input", () => {
        fetchPlans(searchInput.value, currentStatus);
    });

    // الفلترة
    filterButtons.forEach(btn => {
        btn.addEventListener("click", function() {
            currentStatus = this.dataset.status;
            fetchPlans(searchInput.value, currentStatus);
            dropdownMenu.classList.add("hidden");
            dropdownIcon.style.transform = "rotate(0deg)";
        });
    });

});
</script>



{% endblock %}
