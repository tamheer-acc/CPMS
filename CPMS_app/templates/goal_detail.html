{% extends 'base.html' %}
{% load l10n %}

{% block breadcrumb %}

<!-- for GM, CM, M -- when come from goal list page -->
{% if breadcrumb_source == 'goals_list' %}
    <li class="flex items-center">
        <span class="mx-2">/</span>
        <a href="{% url 'goals_list' %}" class="hover:text-gray-700">الأهداف</a>
    </li>
    <li class="flex items-center">
        <span class="mx-2">/</span>
        <span class="text-gray-800 font-semibold">تفاصيل الهدف</span>
    </li>

<!-- for GM, CM, M -- when the plan is active and they come from dashboard -->
{% elif breadcrumb_source == 'dashboard' %}
    <li class="flex items-center">
        <span class="mx-2">/</span>
        <span class="text-gray-800 font-semibold">تفاصيل الهدف</span>
    </li>
 
<!-- for GM, CM, M -- when the plan is inactive -->   
{% elif breadcrumb_source == 'plan_detail' %}
<li class="flex items-center">
        <span class="mx-2">/</span>
        <a href="{% url 'plan_detail' plan.id %}" class="hover:text-gray-700">تفاصيل الخطة</a>
    </li>
    <li class="flex items-center">
        <span class="mx-2">/</span>
        <span class="text-gray-800 font-semibold">تفاصيل الهدف</span>
    </li>

<!-- for E -->
 {% elif request.user.role.role_name == 'E' %}
<li class="flex items-center">
    <span class="mx-2">/</span>
    <span class="text-gray-800 font-semibold">تفاصيل الهدف</span>
</li>


{% endif %}

{% endblock %}

{% block content %}
{% include "partials/confirm_delete.html" %}
<!-- header -->
<div class="max-w-5xl mx-auto bg-white rounded-2xl shadow-lg border border-gray-200 p-6 mt-10 mb-6 space-y-12">
    <div class="flex flex-col  md:flex-row items-center justify-between gap-4">
        <div class="flex items-start gap-3">
            <svg xmlns="http://www.w3.org/2000/svg" width="48" height="48" viewBox="0 0 24 24" fill="none"
                stroke="#00675B" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"
                class="icon icon-tabler icons-tabler-outline icon-tabler-target-arrow">
                <path stroke="none" d="M0 0h24v24H0z" fill="none" />
                <path d="M11 12a1 1 0 1 0 2 0a1 1 0 1 0 -2 0" />
                <path d="M12 7a5 5 0 1 0 5 5" />
                <path d="M13 3.055a9 9 0 1 0 7.941 7.945" />
                <path d="M15 6v3h3l3 -3h-3v-3l-3 3" />
                <path d="M15 9l-3 3" />
            </svg>
            <div class="flex flex-col mt-1 space-y-1">
                <h1 class="text-3xl font-bold text-[#00675B]">
                    {{ goal.goal_title }}
                </h1>
                <p class="text-sm text-gray-500">هدف استراتيجي</p>
            </div>
        </div>
        <div class="flex gap-3">
            <!-- status -->
            <span class="px-3 py-1  rounded-full text-sm font-medium 
            {% if goal.goal_status == 'IP' %}bg-blue-100 text-blue-800
            {% elif goal.goal_status == 'C' %}bg-green-100 text-green-800
            {% elif goal.goal_status == 'D' %}bg-red-100 text-red-800
            {% else %}bg-gray-100 text-gray-800{% endif %}">
                {{ goal.get_goal_status_display }}
            </span>

            <!-- priority -->
            <span class="px-3 py-1 rounded-full text-sm font-medium
                {% if goal.goal_priority == 'C' %}   border-red-500    red-600    bg-red-100    text-red-800  
                {% elif goal.goal_priority == 'H' %} border-orange-500 orange-500 bg-orange-100 text-orange-800
                {% elif goal.goal_priority == 'M' %} border-yellow-500 yellow-500 bg-yellow-100 text-yellow-800 
                {% else %} border-green-500  green-500  bg-green-100  text-green-800 {% endif %}">
                {{ goal.get_goal_priority_display }}
            </span>
        </div>
    </div>

    <!-- dates, department -->
    <div
        class="bg-[#00675B]/30 rounded-full shadow border border-gray-200 p-1 flex flex-col md:flex-row items-center justify-center ">

        <div class="inline-flex justify-center items-center gap-9 text-base">

            <span class="flex items-center  justify-center gap-3 text-sm">
                <h1 class="font-medium"> تاريخ البداية </h1>
                <h1 class="rounded-full items-center inline-flex gap-2 px-3 border bg-gray-100">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 16 16" fill="currentColor"
                        class="size-5 text-[#3b4444]">
                        <path
                            d="M5.75 7.5a.75.75 0 1 0 0 1.5.75.75 0 0 0 0-1.5ZM5 10.25a.75.75 0 1 1 1.5 0 .75.75 0 0 1-1.5 0ZM10.25 7.5a.75.75 0 1 0 0 1.5.75.75 0 0 0 0-1.5ZM7.25 8.25a.75.75 0 1 1 1.5 0 .75.75 0 0 1-1.5 0ZM8 9.5A.75.75 0 1 0 8 11a.75.75 0 0 0 0-1.5Z" />
                        <path fill-rule="evenodd"
                            d="M4.75 1a.75.75 0 0 0-.75.75V3a2 2 0 0 0-2 2v7a2 2 0 0 0 2 2h8a2 2 0 0 0 2-2V5a2 2 0 0 0-2-2V1.75a.75.75 0 0 0-1.5 0V3h-5V1.75A.75.75 0 0 0 4.75 1ZM3.5 7a1 1 0 0 1 1-1h7a1 1 0 0 1 1 1v4.5a1 1 0 0 1-1 1h-7a1 1 0 0 1-1-1V7Z"
                            clip-rule="evenodd" />
                    </svg>
                    {{ goal.start_date|date:"Y/m/d" }}
                </h1>
            </span>

            <span class="flex items-center justify-center gap-3 text-sm">
                <h1 class="font-medium"> تاريخ النهاية </h1>
                <h1 class="rounded-full items-center inline-flex gap-2 px-3 border bg-gray-100">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 16 16" fill="currentColor"
                        class="size-5 text-[#3b4444]">
                        <path
                            d="M5.75 7.5a.75.75 0 1 0 0 1.5.75.75 0 0 0 0-1.5ZM5 10.25a.75.75 0 1 1 1.5 0 .75.75 0 0 1-1.5 0ZM10.25 7.5a.75.75 0 1 0 0 1.5.75.75 0 0 0 0-1.5ZM7.25 8.25a.75.75 0 1 1 1.5 0 .75.75 0 0 1-1.5 0ZM8 9.5A.75.75 0 1 0 8 11a.75.75 0 0 0 0-1.5Z" />
                        <path fill-rule="evenodd"
                            d="M4.75 1a.75.75 0 0 0-.75.75V3a2 2 0 0 0-2 2v7a2 2 0 0 0 2 2h8a2 2 0 0 0 2-2V5a2 2 0 0 0-2-2V1.75a.75.75 0 0 0-1.5 0V3h-5V1.75A.75.75 0 0 0 4.75 1ZM3.5 7a1 1 0 0 1 1-1h7a1 1 0 0 1 1 1v4.5a1 1 0 0 1-1 1h-7a1 1 0 0 1-1-1V7Z"
                            clip-rule="evenodd" />
                    </svg>
                    {{ goal.end_date|date:"Y/m/d" }}
                </h1>
            </span>

            <span class="flex items-center  justify-center gap-3 text-sm">
                <h1 class="font-medium"> الإدارة </h1>
                <h1 class="rounded-full items-center inline-flex gap-1 px-3 border bg-gray-100">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none"
                        stroke="#3b4444" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"
                        class="icon icon-tabler icons-tabler-outline icon-tabler-building-skyscraper">
                        <path stroke="none" d="M0 0h24v24H0z" fill="none" />
                        <path d="M3 21l18 0" />
                        <path d="M5 21v-14l8 -4v18" />
                        <path d="M19 21v-10l-6 -4" />
                        <path d="M9 9l0 .01" />
                        <path d="M9 12l0 .01" />
                        <path d="M9 15l0 .01" />
                        <path d="M9 18l0 .01" />
                    </svg>
                    {{ goal.department.department_name }}
                </h1>
            </span>

        </div>

    </div>

    <!-- charts -->
    <div class="flex flex-wrap gap-6 justify-around">
        <!-- initiatives -->
        <div
            class="w-48 h-48 rounded-full bg-[#00675B]/10 border border-[#00675B]/30 flex flex-col items-center justify-center">
            <span class="text-[#00675B] font-bold text-lg leading-tight text-center">
                {% if initiatives_count == 0%}
                لا توجد مبادرات
                {% elif initiatives_count == 1 %}
                مبادرة واحدة
                {% elif initiatives_count == 2 %}
                مبادرتان
                {% elif initiatives_count <= 10 %} {{initiatives_count}} مبادرات {% else %} {{initiatives_count}} مبادرة
                    {% endif %} </span>
        </div>

        <!-- progress -->
        <div class="w-48 h-48 rounded-full bg-white shadow-lg flex items-center justify-center relative">
            <svg class="w-48 h-48 transform -rotate-90">
                <circle cx="50%" cy="50%" r="45%" stroke="#e5e7eb" stroke-width="10" fill="none" />
                <circle cx="50%" cy="50%" r="45%" stroke="#00675B" stroke-width="10" fill="none"
                    stroke-dasharray="542.9" stroke-linecap="round"
                    style="stroke-dashoffset: calc(542.9 - (542.9 * {{ progress|unlocalize }} / 100));" />
            </svg>

            <div class="absolute text-center">
                <div class="text-2xl font-bold text-[#00675B]">
                    {{ progress|unlocalize }}%
                </div>
                <div class="text-xs text-gray-500 mt-1">
                    التقدم الكلي
                </div>
            </div>
        </div>

        <!-- time remaininf -->
        <div class="w-48 h-48 rounded-full bg-white shadow flex items-center justify-center relative">
            <svg class="w-48 h-48 transform -rotate-90">
                <circle cx="50%" cy="50%" r="45%" stroke="#e5e7eb" stroke-width="8" fill="none" />
                <circle cx="50%" cy="50%" r="45%" stroke="#00675B" stroke-width="8" fill="none" stroke-dasharray="542.9"
                    stroke-linecap="round"
                    style=" stroke-dashoffset: calc( 542.9 - (542.9 * {{ passed_duration_percent|unlocalize }} / 100));" />
            </svg>
            <div class="absolute text-center">
                <span dir="ltr" class="text-lg font-bold">{{passed}} <span class=" text-gray-400 text-sm">
                        /{{duration}}</span></span>
                <div class="text-xs text-gray-500">عدد الأيام المنقضية</div>
            </div>
        </div>
    </div>
    <div class="space-y-6">
        <!-- description -->
        <div class="bg-white p-4 rounded-lg shadow">
            <h3 class="font-semibold text-[#00675B] mb-2">الوصف</h3>
            <p class="text-gray-700 whitespace-pre-line">{{ goal.description }}</p>
        </div>

        <!-- initiatives -->
        <div class="bg-white rounded-lg shadow border border-gray-200 p-6">
            <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center mb-5 gap-3">
                <h3 class="flex items-center text-xl font-semibold text-[#00675B] gap-2">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none"
                        stroke="#00675B" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"
                        class="icon icon-tabler icons-tabler-outline icon-tabler-badges">
                        <path stroke="none" d="M0 0h24v24H0z" fill="none" />
                        <path d="M17 17v-4l-5 3l-5 -3v4l5 3l5 -3" />
                        <path d="M17 8v-4l-5 3l-5 -3v4l5 3l5 -3" />
                    </svg>
                    المبادرات المرتبطة بالهدف الاستراتيجي
                </h3>
                {% if user.role.role_name == 'CM' or user.role.role_name == 'M' %}
                 {% if is_plan_active %}

                <a href="{% url 'initiative_create' goal.id %}"
                    class="px-4 py-2 bg-blue-600 hover:bg-blue-700 text-white rounded-lg transition">
                    إضافة مبادرة جديدة
                </a>
                 {% endif %}
                {% endif %}
            </div>

            <div class="grid grid-cols-1 gap-4">
                {% for initiative in initiatives %}
                <a href="{% url 'initiative_detail' initiative.id %}"
                    class="flex flex-col justify-center items-center p-4 bg-[#F9FAFB] border border-gray-200 rounded-lg shadow-sm hover:shadow-md hover:border-[#00675B] transition group">
                    <p class="text-gray-700 font-medium text-center">{{ initiative.title }}</p>
                </a>
                {% empty %}
                <p class="text-gray-500 text-center col-span-full">لا توجد مبادرات مرتبطة بهذا الهدف.</p>
                {% endfor %}
            </div>

        </div>
    </div>

    <!-- edit and delete -->
    {% if user.role.role_name == 'CM' or user.role.role_name == 'M' %}
     {% if is_plan_active %}
    <div class="flex justify-center gap-10">
        <a href="{% url 'goal_update' goal.id %}"
            class="bg-yellow-600 rounded-lg p-3 items-center hover:bg-yellow-800 text-white rounded-lg transition-colors flex gap-1">
            <svg xmlns="http://www.w3.org/2000/svg" class="w-5 h-5" fill="none" stroke="currentColor" stroke-width="2"
                stroke-linecap="round" stroke-linejoin="round" viewBox="0 0 24 24">
                <path stroke="none" d="M0 0h24v24H0z" fill="none" />
                <path d="M7 7h-1a2 2 0 0 0 -2 2v9a2 2 0 0 0 2 2h9a2 2 0 0 0 2 -2v-1" />
                <path d="M20.385 6.585a2.1 2.1 0 0 0 -2.97 -2.97l-8.415 8.385v3h3l8.385 -8.415" />
                <path d="M16 5l3 3" />
            </svg>
            تعديل الهدف
        </a>

        <button
            class="bg-red-600 rounded-lg p-3 items-center  hover:bg-red-800 text-white rounded-lg transition-colors flex gap-1"
            onclick="openDeleteModal( 
                        '/goals/{{ goal.id }}/delete/',
                        'هل أنت متأكد أنك تريد حذف هذا الهدف؟'
                    )">
            <svg xmlns="http://www.w3.org/2000/svg" class="w-5 h-5" fill="none" stroke="currentColor" stroke-width="2"
                stroke-linecap="round" stroke-linejoin="round" viewBox="0 0 24 24">
                <path stroke="none" d="M0 0h24v24H0z" fill="none" />
                <path d="M4 7l16 0" />
                <path d="M10 11l0 6" />
                <path d="M14 11l0 6" />
                <path d="M5 7l1 12a2 2 0 0 0 2 2h8a2 2 0 0 0 2 -2l1 -12" />
                <path d="M9 7v-3a1 1 0 0 1 1 -1h4a1 1 0 0 1 1 1v3" />
            </svg>
            حذف الهدف
        </button>
    </div>
     {% endif %}
    {% endif %}
</div>
{% endblock %}